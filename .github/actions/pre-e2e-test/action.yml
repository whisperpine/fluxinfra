name: Prepare for Flux End-to-end Test
description: Setup kubernetes, install flux, add GitRepository resource
inputs:
  password:
    description: Just assign with secrets.GITHUB_TOKEN
    required: true

runs:
  using: composite
  steps:
    - name: Setup Flux
      uses: fluxcd/flux2/action@main
    - name: Setup Kubernetes in Docker
      uses: helm/kind-action@v1
      with:
        cluster_name: chart-testing-flux
    - name: Install Flux in Kubernetes Kind
      shell: sh
      run: flux install --components-extra source-watcher
    - name: Setup cluster reconciliation
      shell: sh
      run: |
        branch="${GITHUB_REF#refs/heads/}"
        echo "$branch"
        flux create source git ${{ github.event.repository.name }} \
          --url="${{ github.event.repository.html_url }}" \
          --branch="$branch" \
          --username="${{ github.actor }}" \
          --password="${{ inputs.password }}"
    - name: Verify cluster reconciliation
      shell: sh
      run: |
        kubectl -n flux-system wait gitrepo/${{ github.event.repository.name }} \
          --for=condition=ready --timeout=30s
